---
title: "Data Mining Final Project"
output: pdf_document
---


**Your Name**: Anasa Alamgir
**Your G Number**: G01300460


```{r warning = FALSE, message = FALSE, include=FALSE}
# Suppress dplyr summarise grouping warning messages
options(dplyr.summarise.inform = FALSE)
## Add R libraries here
library(tidyverse)
library(tidymodels)
library(discrim)
library(kknn)
library(dplyr)
library(klaR)
library(ggplot2)
library(vip)
library(magrittr)
# Load data
loans_df <- read_rds("loan_data.rds")
```

# Introduction 

The Bank has experienced customers defaulting on their loans 
and therefore seeks to predict whether an applicant will default on their loan
in order to protect the Bank from large financial losses.This project aims to 
explore the factors that lead to loan default and use machine learning models 
to predict the chance of an applicant defaulting on their loan in the future. 

Exploratory data analysis can help to find the relationship between whether the 
applicant defaults and the various factors that affect them defaulting on the loan.

# Summary of Results

The default response variable in this data frame is loan_default, which records
whether an applicant has defaulted or not. This variable has also been coded with 
'Yes' and 'No' factors. Therefore using visualization techniques this report will 
show which other factors can explain why some applicants default and others do not.

Findings...


# Data Analysis 



## Question 1



**Question**: Is there a relationship between loan default and loan amount?



**Answer**: As indicated by the distribution of loan amount based on 
whether the applicant defaulted or not, there are a greater number of loans
that did not default at a lower amount, around $10,000, compared to the number 
of loans that did default at the same amount. Therefore it shows that loan
amount might not affect loan default.



```{r, fig.asp=0.6, fig.width=8}
loans_df %>% ggplot(
  aes(x = loan_amount, fill = loan_default)
) +
  geom_histogram(bins=10, color="white") + 
  scale_fill_manual(values = c("#FF3399","#33CC66")) +
  theme_light() +
  facet_wrap(~ loan_default)+
  labs(
    title = "Loan default distribution by loan amount",
    x = "loan amount",
    y = "number of loans"
  )
```



## Question 2



**Question**: Is there a relationship between loan default and history of missed
payments in the past 2 years?



**Answer**: The summary does not show a positive relationship between history
of missed payments and whether the applicant defaulted. There is a higher
number of loans that defaulted but the applicants did not have history of missed
payments in the past 2 years. On the other hand, there is a much higher number 
of loans that did not default but the applicants had history of missed payments 
in the past 2 years.


```{r}

loans_df %>%
  group_by(loan_default, missed_payment_2_yr) %>%
  summarise(
    num_loans = n()
  )
```




## Question 3



**Question**: Is there a relationship between loan default and annual income?



**Answer**: Yes, the summary clearly shows that applicants with a lower
median income ($60,000) and lower average income ($67,818.80) had defaulted
on their loans compared to applicants with higher average and median incomes.


```{r}
loans_df %>% group_by(loan_default) %>%
  summarise(
    avg_income = mean(annual_income),
    median_income = median(annual_income),
    min_income = min(annual_income),
    sd_income = sd(annual_income)
  )
```



## Question 4



**Question**: How does loan default relate to home ownership?



**Answer**: The data indicates that applicants renting their home are more
likely to default on their loans compared to a far lesser amount of 
applicants that own their home.


```{r}
loans_df %>% filter(loan_default=="yes") %>% 
  ggplot(aes(x=homeownership, fill=loan_default)) + 
  geom_bar(fill="#7ACBFF") +
  theme_minimal() + labs(
    title="Distribution of loans defaulted based on home ownership", 
    fill="loan default"
  )
```



## Question 5


**Question**: Is there a relationship between loan default and debt-to-income 
ratio?


**Answer**: The density plot shows that applicants with higher debt-to-income
ratio defaulted more often than applicants with a lower debt to income ratio. 
This is most likely because applicants with higher debt to income ratio already
have substantial amount of debt compared to their income to be able to pay
on their installments. Applicants with much lower debt to income ratio are
less likely to have defaulted on their loans.


```{r, fig.width=9, fig.asp=0.5}
loans_df %>% ggplot(
  aes(x = debt_to_income, color = loan_default)
) + geom_density() + xlim(0,100)+ 
  theme_light() +
scale_fill_brewer(palette="Set1") +
  labs(
    title = "Distribution of debt to income ratio by loans defaulted",
    color = "loan defaulted",
    x = "debt to income ratio"
  )
```



## Question 6


**Question**: How is loan default related to application type and 
years of credit history?


**Answer**: The summary indicates that individual applications that got 
defaulted had a smaller average credit history when compared to joint applications
with lower credit history that went into default. On the other hand, for both
types of applications, the ones with higher average credit history did not go 
into default.



```{r}
loans_df %>%  group_by(loan_default,application_type) %>% summarize(
  avg_credit_history=mean(years_credit_history))
```



## Question 7


**Question**: Is there a relationship between loan default rate and interest 
rates and loan purpose?


**Answer**: Out of the applicants that defaulted on their loans, small business
and credit card loans have the highest median interest rates. Therefore, it can 
be stated that applicants are more likely to default on their loans with a higher
interest rate, especially when it is for a small business or credit card.


```{r}
loans_df %>% filter(loan_default == "yes") %>%
  group_by(loan_default, loan_purpose) %>%
  summarise(
    med_interestrate = median(interest_rate))
```


# Predictive Modeling 


## Model 1 Logistic Regression

```{r}
#split loans_df into training and test sets
set.seed(172)
loan_split <- initial_split(loans_df, prop = 0.75,
                            strata = loan_default)
loan_training <- loan_split %>% training()
loan_test <- loan_split %>% testing()
```

```{r}
#cross validation folds for hyperparameter tuning
set.seed(172) 
loan_folds <- vfold_cv(loan_training, v = 6)
```

```{r}
#feature engineering
loan_recipe <- recipe(loan_default ~ .,data = loan_training) %>%
  step_YeoJohnson(all_numeric(), -all_outcomes()) %>%
  step_normalize(all_numeric(), -all_outcomes()) %>%
  step_dummy(all_nominal(), -all_outcomes())
loan_recipe %>%
  prep(training = loan_training) %>%
  bake(new_data = NULL)
```


```{r}
#specify model
loan_logistic <- logistic_reg() %>%
  set_engine('glm') %>%
  set_mode('classification')
```

```{r}
#create workflow
logistic_wf <- workflow() %>%
  add_model(loan_logistic) %>%
  add_recipe(loan_recipe)
#roc curve and auc
logistic_fit <- logistic_wf %>% last_fit(split = loan_split)
# collect predictions
logistic_predictions <- logistic_fit %>% collect_predictions()
```



```{r}
#confusion matrix
conf_mat(logistic_predictions,
         truth = loan_default,
         estimate = .pred_class)
```


```{r}
#roc curve
roc_curve(logistic_predictions,
          truth = loan_default,
          estimate = .pred_yes) %>% autoplot()
```


```{r}
#area under curve
roc_auc(logistic_predictions, truth = loan_default, .pred_yes)
```



```{r}
#model summary 
log_model <- glm(loan_default ~., data = loan_training, family = binomial())
tidy(log_model)
```

```{r}
summary(log_model)
```


```{r}
vip(log_model)
```




## Model 2 LDA

```{r}
#specify model
loan_lda <- discrim_regularized(frac_common_cov = 1) %>%
  set_engine("klaR") %>%
  set_mode("classification")
```


```{r}
#workflow
lda_wf <- workflow() %>% add_model(loan_lda) %>% add_recipe(loan_recipe)
```

```{r}
#fit workflow
lda_fit <- lda_wf %>% last_fit(split=loan_split)
```

```{r}
#collect predictions
lda_predictions <- lda_fit %>% collect_predictions()
```

```{r}
#confusion matrix
conf_mat(lda_predictions, truth = loan_default, estimate = .pred_class)
```

```{r}
#roc curve
roc_curve(lda_predictions, truth=loan_default, estimate= .pred_yes) %>%
  autoplot()
```


```{r}
#Area under ROC
roc_auc(lda_predictions, truth=loan_default, .pred_yes)
```




## Model 3 K-Nearest Neighbor 

```{r}
#specify model
knn_model <- nearest_neighbor(neighbors = tune()) %>%
  set_engine("kknn") %>%
  set_mode("classification")
```


```{r}
#workflow
knn_wf <- workflow() %>%
  add_model(knn_model) %>%
  add_recipe(loan_recipe)
```



```{r}
#create grid for hyperparameter testing
k_grid <- tibble(neighbors = c(10,20,30,40,50,75,100,125,150))
```


```{r}
#tuning wf
set.seed(271)
knn_tuning <- knn_wf %>% tune_grid(resamples=loan_folds, grid=k_grid)
#select best model from tuning result
best_k <- knn_tuning %>% select_best(metric='roc_auc')
#add optimal model to wf
final_knn_wf <- knn_wf %>% finalize_workflow(best_k)
#fit model
knn_fit <- final_knn_wf %>% last_fit(split=loan_split)
```

```{r}
#get df of test prediction results
knn_predictions <- knn_fit %>% collect_predictions()
```


```{r}
#confusion matrix
conf_mat(knn_predictions, truth= loan_default, estimate = .pred_class)
```


```{r}
#roc curve 
roc_curve(knn_predictions, truth = loan_default, estimate= .pred_yes) %>%
  autoplot()

```

```{r}
#Are under ROC
roc_auc(knn_predictions, truth = loan_default, estimate= .pred_yes)
```





--- End of the Project ---